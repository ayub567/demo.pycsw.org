<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>pycsw viewer</title>
        <style type="text/css">
            body {
                background-color: #ffffff;
                font-family: arial, verdana, sans-serif;
                text-align: left;
                float: left;
            }
            .flat {
                border: 0px;
            }
            header {
                display: inline-block;
            }
            #div-map {
                float: left;
                width: 400px;
                height: 200px;
            }
            #div-csw-results {
                float: right;
                width: 500px;
                height: 200px;
                overflow-y: auto;
            }
            footer {
                position: fixed;
                left: 0;
                bottom: 0;
                height: 100px;
                width: 100%;
            }
        </style>
        <!-- leaflet -->
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.3/leaflet.css" />
        <!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.3/leaflet.ie.css" /><![endif]-->
        <script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.6.3/leaflet.js"></script>

        <!-- jQuery -->
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

        <!-- jQuery DataTables -->
        <link rel="stylesheet" type="text/css" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
        <script type="text/javascript" charset="utf-8" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>

        <script type="text/javascript">

            csw_url = "http://demo.pycsw.org/gisdata/csw";

            function escapeElementName(str) {
                return str.replace(':', '\\:').replace('.', '\\.');
            }
            function bbox2polygon(bbox) {
                if (bbox == null) {
                    return new L.Polygon();
                }
                var coords = bbox.split(',');
                var p1 = new L.LatLng(coords[0], coords[1]),
                    p2 = new L.LatLng(coords[2], coords[1]),
                    p3 = new L.LatLng(coords[2], coords[3]),
                    p4 = new L.LatLng(coords[0], coords[3]),
                    polygonPoints = [p1, p2, p3, p4];
                return new L.Polygon(polygonPoints);
            }
            $(document).ready(function(){
                // init the map
                polygon_layer = null;
                var map = L.map('div-map').setView([10, 0], 1);
                L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                // init the results table
                $("#table-csw-results").dataTable({
                    fnDrawCallback: function() {
                        $("#selector thead").remove();
                    }
                });
                // init the type select box
                $.ajax({
                    type: "post",
                    url: csw_url,
                    contentType: "text/xml",
                    data: '<GetDomain service="CSW" version="2.0.2" xmlns="http://www.opengis.net/cat/csw/2.0.2" xmlns:csw="http://www.opengis.net/cat/csw/2.0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/cat/csw/2.0.2 http://schemas.opengis.net/csw/2.0.2/CSW-discovery.xsd"><PropertyName>dc:type</PropertyName></GetDomain>',
                    dataType: "text",
                    success: function(xml) {
                        $(escapeElementName('csw:Value'),xml).each(function(record) {
                            alert($(this).text());
                        });
                    }
                });

                // handle CSW searches
                $("#form-search").keypress(function (e) {
                    if (e.keyCode == 13) { // Enter key pressed, but not submitting the form to a page refresh
                        var freetext = $('#input-anytext').val().trim();
                        var bbox_enabled = $('#input-bbox').is(':checked');
                        var sortby = $('#select-sortby option:selected').val();

                        if (bbox_enabled) {
                            bounds = map.getBounds();
                            qbbox = '<ogc:BBOX><ogc:PropertyName>ows:BoundingBox</ogc:PropertyName><gml:Envelope xmlns:gml="http://www.opengis.net/gml"><gml:lowerCorner>' + bounds.getSouth() + ' ' + bounds.getWest() + '</gml:lowerCorner><gml:upperCorner>' + bounds.getNorth() + ' ' + bounds.getEast() + '</gml:upperCorner></gml:Envelope></ogc:BBOX>';
                        }

                        data = '<csw:GetRecords maxRecords="50" startPosition="1" outputFormat="application/xml" outputSchema="http://www.opengis.net/cat/csw/2.0.2" resultType="results" service="CSW" version="2.0.2" xsi:schemaLocation="http://www.opengis.net/cat/csw/2.0.2 http://schemas.opengis.net/csw/2.0.2/CSW-discovery.xsd" xmlns:ogc="http://www.opengis.net/ogc" xmlns:csw="http://www.opengis.net/cat/csw/2.0.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><csw:Query typeNames="csw:Record"><csw:ElementSetName>full</csw:ElementSetName>';
                        if (freetext != '') {
                            if (bbox_enabled) {
                                data += '<csw:Constraint version="1.1.0"><ogc:Filter><ogc:And><ogc:PropertyIsLike escapeChar="\\" singleChar="_" wildCard="%"><ogc:PropertyName>csw:AnyText</ogc:PropertyName><ogc:Literal>%' + $("#input-anytext").val().trim() + '%</ogc:Literal></ogc:PropertyIsLike>' + qbbox + '</ogc:And></ogc:Filter></csw:Constraint>';
                            }
                            else {
                                data += '<csw:Constraint version="1.1.0"><ogc:Filter><ogc:PropertyIsLike escapeChar="\\" singleChar="_" wildCard="%"><ogc:PropertyName>csw:AnyText</ogc:PropertyName><ogc:Literal>%' + $("#input-anytext").val().trim() + '%</ogc:Literal></ogc:PropertyIsLike></ogc:Filter></csw:Constraint>';
                            }
                        }
                        else if (bbox_enabled) {
                            data += '<csw:Constraint version="1.1.0"><ogc:Filter>' + qbbox + '</ogc:Filter></csw:Constraint>';
                        }
  
                        data += '<ogc:SortBy><ogc:SortProperty><ogc:PropertyName>' + sortby  + '</ogc:PropertyName><ogc:SortOrder>ASC</ogc:SortOrder></ogc:SortProperty></ogc:SortBy>';

                        data += '</csw:Query></csw:GetRecords>';

                        $.ajax({
                            type: "post",
                            url: csw_url,
                            contentType: "text/xml",
                            data: data,
                            dataType: "text",
                            success: function(xml) {
                                $("#table-csw-results").dataTable().fnClearTable();
                                //alert(xml);
                                $(escapeElementName('csw:Record'),xml).each(function(record) {
                                    var snippet = "";
                                    var links = "";

                                    var title = $(this).find(escapeElementName('dc:title')).text();
                                    var publisher = $(this).find(escapeElementName('dc:publisher')).text();
                                    var identifier = $(this).find(escapeElementName('dc:identifier')).text();
                                    var abstract = $(this).find(escapeElementName('dct:abstract')).text();
                                    var source = $(this).find(escapeElementName('dc:source')).text();
                                    var rectype = $(this).find(escapeElementName('dc:type')).text();
                                    var thumb = $(this).find(escapeElementName('dct:references')+'[scheme="WWW:LINK-1.0-http--image-thumbnail"]').text();
                                    var bbox = $(this).find(escapeElementName('ows:BoundingBox')).text();
                                    var ll = $(this).find(escapeElementName('ows:LowerCorner')).text().split(' ');
                                    var ur = $(this).find(escapeElementName('ows:UpperCorner')).text().split(' ');
                                    var bbox = ll.concat(ur).join();

                                    // get all links
                                    $(this).find(escapeElementName('dct:references')).each(function() {
                                        var value = $(this).text();
                                        if (value != "None" && value.lastIndexOf("http", 0) === 0) {
                                            links += ' <a title="' + $(this).attr('scheme')  + '" href="' + value + '">link</a> '; 
                                        }
                                    });

                                    url = csw_url + "?service=CSW&version=2.0.2&request=GetRecordById&elementsetname=full&id=" + identifier;
                                    title2 = '<a id="' + bbox + '" class="a-record" target="_blank" title="' + title + '" href="' + url  + '">' + title + '</a>';
                                    snippet += '<h5>' + title2 + '</h5>';
                                    snippet += '<i>' + publisher + '</i>';
                                    snippet += links;

                                    $("#table-csw-results").dataTable().fnAddData([snippet]);
                                })
                            }
                        });
                        return false;
                    }
                });
                $("table").on("mouseenter", "td", function(event) {
                    bbox = $(this).find('[id]').attr('id');
                    if (polygon_layer != null && map.hasLayer(polygon_layer)) {
                        map.removeLayer(polygon_layer);
                    }
                    polygon_layer = bbox2polygon(bbox);
                    map.addLayer(polygon_layer);
                });
            });
        </script>
    </head>
    <body>
        <header>
            <h1>pycsw viewer</h1>
        </header>
        <section>
            <div>
                <div id="div-search">
                    <form id="form-search">
                        Type: <select id="select-type"></select>
                        Search Terms: <input type="text" id="input-anytext"/>
                        Enable bbox? <input type="checkbox" id="input-bbox"/>
                        Sort by: <select id="select-sortby"><option value="dc:title">Title</option><option value="dc:date">Date</option></select>
                    </form>
                </div>
                <div id="div-map"></div>
                <div id="div-csw-results">
                    <table id="table-csw-results">
                        <thead>
                            <tr>
                                <th>Record</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </section>
        <footer>
        <hr>
            <a href="http://validator.w3.org/check?verbose=1&amp;uri=referer" title="Valid HTML 5!"><img class="flat" src="http://www.w3.org/html/logo/downloads/HTML5_Badge_32.png" alt="Valid HTML 5!" height="32" width="32"/></a>
            <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS!"><img class="flat" src="http://jigsaw.w3.org/css-validator/images/vcss-blue" alt="Valid CSS!" height="31" width="88"/></a>
        </footer>
    </body>
</html>
